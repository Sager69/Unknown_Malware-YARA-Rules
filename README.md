# Unknown_Malware-YARA-Rules

# Intrusion Detection & Network Forensics — Assignment 2 (The Unknown Malware)

### This assignment is submitted by Ali AlNeis and Mohammad Al-Otoum as part of the Intrusion Detection & Network Forensics course at Princess Sumaya University for Technology, given by the great Dr. Haitham Al-Ani. 

The following is the static and dynamic analysis steps taken to analyze the malware, and as a result, to write the YARA rules for. The malware was written by Dr. Haitham, and the password for the zip file is "infected". Please perform the malware analysis in a safe, isolated environment and make sure to:
- Do not download these samples to a computer you do not own.
- Do not execute any of these samples on a computer you do not own.
- Do not download and/or execute these samples in an environment that you cannot revert to a saved state, i.e. a virtual machine.
- Practice safe malware handling procedures at all times when using these samples.

---

The analysis is carried out on Windows 10 Flare VM and Remnux.

## Static Analysis

### Hashing

To check the malware’s presence on the internet, we will first check the hashes of the malware using `sha256sum.exe` and `md5sum` tools. The resulting hashes are as follows:

> SHA-256: 3c09c7591a85f674b033c17f7d80535963f179b4fcd7fe2aba5f2ec5d6813405

> MD5: 6147b3df04d5d93d9186f3ede6e74b71

Testing the hashes against VirusTotal’s database, we get the following result:

![Untitled](https://user-images.githubusercontent.com/52178283/211702061-952887c4-b2f4-4b9f-a648-f09e25bd8fef.png)

### Strings

To get an idea of the strings embedded in the malware, we will use `floss` against the executable file and look for interesting strings that could direct us in the dynamic analysis phase.

![Untitled 1](https://user-images.githubusercontent.com/52178283/211702107-c0df1d83-0399-47ec-bb15-f9aa5115c273.png)

Looking through the output of `floss`, we found some interesting strings, listed below:

```
CaesarCipher
intShift
PSUT.dll is missing!
C:\windows\updator.exe
@*\AC:\Users\Haitham\Desktop\AAAA\Project1.vbp
C:\Users\Hacked.txt
http://www.example.com/post_handler
WScript.Shell
HKEY_CURRENT_USER\Software\MyApp\Key
https://www.google.com
```

Based on the strings found, we can predict that the malware will be accessing the internet. We can also see that the malware has been written in Visual Basic. It also seems like that the malware will modify/create a registry key. `WScript.Shell` is also usually associated with executing shell scripts.

### PEview

Opening the malware with PEview shows us more information. The first thing we noticed is that the malware’s creation date is very recent (26/12/2022). We also notice that the virtual size and size of raw data values are slightly, therefore that difference is not alarming, so the malware is probably not packed.

![Untitled 2](https://user-images.githubusercontent.com/52178283/211702175-8c79baee-5f11-4533-bbcf-5a97cd7313eb.png)

### PEstudio

Opening the malware with PEstudio gives a more ordered overview of the malware. The malware only uses one library, which is `MSVBVM60.DLL`. 

![Untitled 3](https://user-images.githubusercontent.com/52178283/211702239-4bb66fa7-003e-4c2b-bdeb-673a7301ad66.png)

## Dynamic Analysis

Before we run the malware, we make sure we are running the `inetsim` service on the Remnux machine to simulate an internet connection, should the malware check for internet connectivity. In addition to `inetsim`, we will be listening for capturing packets coming from the malware trying to connect to the “internet.” 

We also took a snapshot of the Windows machine pre-detonation so that we can revert to it if the malware got out of control.

ProcMon and TCPview are prepared with a filter looking for a process with a process name of “Unknown_Malware.exe” so that we’ll see what the malware is doing upon execution. 

Upon running the malware as administrator, we are given the following message box:

![Untitled 4](https://user-images.githubusercontent.com/52178283/211702261-4264eb02-fe28-4e7d-8bc8-2553df91c8c9.png)

Clicking on “OK” results in another program showing another message box:

![Untitled 5](https://user-images.githubusercontent.com/52178283/211702290-a6a7201a-70bf-46bd-88e0-8d4861e626c1.png)

The second program’s name is “updator.exe”, which we’ve seen while performing the static analysis. We’ll add the new program’s name to ProcMon’s filters so that it shows both the first and second executables’ behavior.

![Untitled 6](https://user-images.githubusercontent.com/52178283/211702322-e4399d33-ee0d-4cb0-88b4-e7676eec95db.png)

Although we have made sure that `inetsim` is working properly, the malware seems to know that the supplied internet connection is not as real enough. Looking through the traffic in Wireshark on Remnux, we see the following:

![Untitled 7](https://user-images.githubusercontent.com/52178283/211702340-406cc003-96d2-4bea-bc7f-5f7879211170.png)

We can see that the malware is querying Google’s IP address, and the `inetsim` is responding to its request. Another thing that’s happening is a TLSv1.2 handshake happening between the `inetsim` and the malware. Although the handshake seems to be complete, the malware must have known that `inetsim`'s certificate is not legit. We can work around this problem by disabling HTTPS and SMTPS services in `inetsim`, and using [PolarProxy](https://www.netresec.com/?page=Blog&month=2019-12&post=Installing-a-Fake-Internet-with-INetSim-and-PolarProxy).

![Untitled 8](https://user-images.githubusercontent.com/52178283/211702358-6a163b63-5ff4-4789-ac7a-64cc43c35117.png)

After installing the TLS certificate on the Windows machine, running the malware does not show the “No internet. No game” message box, which means that it connected to the `inetsim` successfully. Looking through ProcMon, we can see that the process “updator.exe” has created a registry key “HKEY_CURRENT_USER\Software\MyApp\Key” and modified its value, and downloaded a file and saved it as “Hacked.txt.”

![Untitled 9](https://user-images.githubusercontent.com/52178283/211702425-e03fdf55-057e-47b0-bb5f-0e1e2015ff44.png)

Yet, the contents of the file “Hacked.txt” are as follows:

![Untitled 10](https://user-images.githubusercontent.com/52178283/211702453-8f503519-6482-4cef-92aa-e45c00b17d88.png)

It seems that the string “CaesarCipher” is hinting that the file is encrypted using the Caesar Cipher algorithm. Testing all possible shifts at [dcode.fr](http://dcode.fr) results in the following string when shifting the encrypted text 4 characters to the left:

```
Computer$Name>$DESKTOP1E=TODRB
Private$IP>$54242428
```

We can see that the modified value of the registry key created by “updator.exe” is also 4, which might reflect the Caesar Cipher algorithm’s shift.

In addition, looking at the traffic in Wireshark, it seems that the malware requested to download the file “connecttest.txt” to ensure network connectivity, which is provided by the `inetsim`.

![Untitled 11](https://user-images.githubusercontent.com/52178283/211702542-8df9480a-958c-42b5-9ec6-90f32fb21f4b.png)

## YARA Rules

To write the YARA rules for the analyzed malware, we will use the information we gathered during our analysis. The following rules are written and tested against the Desktop folder recursively to make sure of the validity of the rule.

```
import "hash" 

rule malware_detection_strings {
    meta:
        description = "Rule to detect the malware based on specific strings"
        author = "Ali AlNeis and Mohammad Al-Otoum"
        date = "2023-01-10"
    strings:
        $CaesarCipher = "CaesarCipher"
        $intShift = "intShift"
        $PSUTdll = "PSUT.dll is missing!"
        $updator = "C:\\windows\\updator.exe"
        $desktop = "@*\\AC:\\Users\\Haitham\\Desktop\\AAAA\\Project1.vbp"
        $hacked = "C:\\Users\\Hacked.txt"
        $post_handler = "http://www.example.com/post_handler"
        $regkey = "HKEY_CURRENT_USER\\Software\\MyApp\\Key"
        $google = "https://www.google.com"
    condition:
        uint16(0) == 0x5A4D and all of them
}

rule malware_detection_characteristics {
    meta:
        description = "Rule to detect the malware based on specific characteristics like file size, and hashes"
        author = "Ali AlNeis and Mohammad Al-Otoum"
        date = "2023-01-10"
    condition:
        uint16(0) == 0x5A4D and (filesize == 53248) and (hash.md5(0, filesize) == "6147b3df04d5d93d9186f3ede6e74b71") and
        (hash.sha256(0, filesize) == "3c09c7591a85f674b033c17f7d80535963f179b4fcd7fe2aba5f2ec5d6813405")
}
```

The result of running the YARA rule against the Desktop folder is shown below:

![Untitled 12](https://user-images.githubusercontent.com/52178283/211702566-de03e8f1-b788-48ca-a1c1-4bd9054d0c68.png)
